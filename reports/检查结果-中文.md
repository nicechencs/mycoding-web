# 代码健康检查结果（中文）

生成时间：2025-09-13（复检已更新）

本次对项目执行了以下检查，并将原始日志保存于 `reports` 目录：

- Lint 日志：`reports/lint.txt`
- TypeScript 类型检查：`reports/type-check.txt`
- 单元测试：`reports/test.txt`
- 构建日志：`reports/build.txt`
- 英文摘要：`reports/summary.md`

## 快速统计（最新复检）

- Lint：错误 492，警告 168
- TypeScript：错误 0（仅对源码进行类型检查）
- 构建：失败（仍被 ESLint 阻断）
- 测试：
  - Test Suites：2 失败，5 通过，共 7
  - Tests：5 失败，108 通过，共 113

> 以上统计来自最新一次复检，详见各日志文件。

## 主要问题概览（更新）

- 构建阶段
  - 编译成功，但在 “Lint 与类型校验” 阶段失败（Next 默认在构建期强制运行 ESLint）。

- TypeScript（源码与测试）
  - React Hooks 规则：`src/components/ui/input.tsx` 条件调用 `React.useId`（必须无条件、固定顺序调用）。
  - 导航实现使用 `window.location.href`，在 jsdom 环境导致测试报错；应改为 Next 的 `useRouter().push` 并在测试中 mock。
  - 多处 props 类型与使用不一致（如 actions/stats 组件属性缺失或命名不符）。
  - `LazyImageOptions` 使用了不存在的字段（如 `preloadOnHover`）。
  - `src/services/index.ts` 引用了未定义的标识符（如 `articlesService`、`globalCache`）。
  - `PerformanceWrapper` 对 `requestIdleCallback`/`cancelIdleCallback` 的声明与 DOM 类型冲突。
  - `never[]` 推断导致 `setState` 无法接受 `Comment[]`/`Favorite[]` 等，需要显式泛型或初始值。
  - 测试代码错误：尝试写 `process.env.NODE_ENV`（只读）、字面量类型不匹配（如要求 'desktop' 却传 'mobile'）。

- ESLint/Prettier
  - 大量 Prettier 格式问题（含异常空格/点号等），未使用的变量/导入广泛存在。
  - 规则类：`no-console`、`prefer-const`、`react/display-name`、`@typescript-eslint/no-explicit-any` 等。
  - 多处 `<img>` 触发 `@next/next/no-img-element` 警告，建议替换为 `next/image`。

- 单元测试
  - 已修复：导航相关（use-navigation-handler）、ResourceStats、ResourceCard 测试全部通过。
  - 仍失败：
    - Header：测试期望出现“设置”，实现仅有“个人中心”“退出登录”。
    - AuthProvider：若干用例因错误日志与异步更新断言不一致而失败，需要对测试或组件的错误处理与状态流进行一致化（使用 act/waitFor，或在测试中 mock 日志与 Token 刷新）。

## 建议修复顺序（下一步）

1. 快速降噪
   - 运行：`npm run format` 与 `npm run lint:fix`，清理大部分格式问题与可自动修复项。
   - 手动删除或使用未使用的导入/变量。

2. 关键规则修复（已完成部分）
   - 已修：`src/components/ui/input.tsx` Hooks 调用；导航逻辑改为 useRouter；类型错配与 never[] 推断；SWR mutate 形参类型；resource-stats 接口与测试对齐。
   - 待修：批量 ESLint 错误（未使用变量/导入、prettier 格式、大量 no-console、若干 @next/next/no-img-element）。

3. 类型错误收敛
   - 统一组件 props 类型与使用（actions/stats/resources/posts 等）。
   - 导航改为 `useRouter().push` 并在测试中 mock。
   - 移除 `LazyImageOptions` 中不存在的字段。
   - 移除/修正 `src/services/index.ts` 中未定义引用。
   - 去掉对 DOM 已有 API 的重复类型声明（`requestIdleCallback` 等）。
   - 修正 `never[]` 推断问题（显式类型或合适初始值）。

4. 测试与实现对齐
   - Header：补充“设置”项或更新测试期望。
   - AuthProvider：统一错误处理与测试断言（建议在测试中 mock console，使用 waitFor/act 包裹状态更新；或在组件中集中管理错误状态并减少直接 console.error）。

5. 复验
   - 依次执行：`npm run type-check`、`npm run test`、`npm run build`，确保完全通过。

## 临时性解堵（不建议长期使用）

- 在 `next.config.js` 中设置：`eslint.ignoreDuringBuilds = true` 与 `typescript.ignoreBuildErrors = true` 可临时放行构建；建议仅在修复期间短暂启用。
